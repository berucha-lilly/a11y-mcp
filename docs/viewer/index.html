<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Accessibility Artifacts Viewer</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f7f7f7}
    .error{color:#c00;font-weight:600}
    .warning{color:#d88000;font-weight:600}
    label{display:inline-block;margin-right:8px}
  </style>
</head>
<body>
  <h1>Accessibility Artifacts Viewer</h1>
  <p>The viewer will automatically try to load <code>../combined.json</code> from the same artifact folder. If it can't be found, you can upload a combined JSON file below.</p>
  <label for="fileInput">Load JSON (fallback):</label>
  <input type="file" id="fileInput" accept="application/json" aria-label="Load JSON artifact">
  <button id="refreshBtn">Refresh</button>
  <div id="status" role="status" aria-live="polite"></div>
  <div id="summary"></div>
  <table id="violationsTable" style="display:none">
    <thead>
      <tr>
        <th>File</th>
        <th>Line</th>
        <th>Severity</th>
        <th>Rule</th>
        <th>Description</th>
        <th>Fix</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    const input = document.getElementById('fileInput');
    const table = document.getElementById('violationsTable');
    const tbody = table.querySelector('tbody');
    const summary = document.getElementById('summary');

    // Try to auto-load ../combined.json relative to this viewer file
    async function tryAutoLoad() {
      try {
        const resp = await fetch('../combined.json', {cache: 'no-store'});
        if (!resp.ok) throw new Error('Not found');
        const data = await resp.json();
        render(data);
        status.textContent = 'Loaded combined.json successfully.';
        return true;
      } catch (err) {
        status.textContent = 'No combined.json found in artifact folder. Use the loader below.';
        return false;
      }
    }

    // Attempt to auto-load on startup
    tryAutoLoad();

    // Refresh button handler
    document.getElementById('refreshBtn').addEventListener('click', () => {
      status.textContent = 'Refreshing...';
      tryAutoLoad();
    });

    input.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          render(data);
        } catch (err) {
          summary.textContent = 'Invalid JSON file.';
        }
      };
      reader.readAsText(file);
    });

    function render(data) {
      tbody.innerHTML = '';
      let total = 0;
      let errors = 0;
      let warnings = 0;

  const files = data.results || data.files || [];

      files.forEach(f => {
        const violations = f.violations || [];
        violations.forEach(v => {
          const tr = document.createElement('tr');
          const sevClass = v.severity === 'error' ? 'error' : (v.severity === 'warning' ? 'warning' : '');
          const filePath = f.file || f.path || f.filePath || '';
          const fixText = (v.fixSuggestions && v.fixSuggestions.join('<br>')) || v.fix || v.help || '';
          tr.innerHTML = `
            <td>${filePath}</td>
            <td>${v.line || ''}</td>
            <td class="${sevClass}">${v.severity || ''}</td>
            <td>${v.id || ''}</td>
            <td>${v.description || ''}</td>
            <td>${fixText}</td>
          `;
          tbody.appendChild(tr);
          total++;
          if (v.severity === 'error') errors++; else if (v.severity === 'warning') warnings++;
        });
      });

      summary.innerHTML = `<p>Total Violations: <strong>${total}</strong> &nbsp; Errors: <strong>${errors}</strong> &nbsp; Warnings: <strong>${warnings}</strong></p>`;
      table.style.display = total ? 'table' : 'none';
    }
  </script>
</body>
</html>